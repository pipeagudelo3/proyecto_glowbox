{% extends "base.html" %}
{% block title %}Pedido {{ orden.numero }} · Glowbox{% endblock %}

{% block content %}

<style>
  /* Estilos locales del timeline (sin lógica inline) */
  .timeline { display:flex; gap:22px; align-items:center; flex-wrap:wrap; }
  .timeline .chip{
    padding:.35rem .7rem; border-radius:999px; border:1px solid var(--card);
    box-shadow:0 0 0 .5px rgba(255,255,255,.06) inset; background:var(--card);
    color:var(--text);
  }
  .timeline .chip.is-active{
    color:#fff;
    background:linear-gradient(90deg,#ff47c2,#3bb3ff);
  }
  .timeline .chip.is-done{
    color:#fff;
    background:linear-gradient(90deg,#3bb3ff,#18e0c4);
    opacity:.95;
  }
  .timeline .sep{ opacity:.5; }
  /* Tabla */
  .od-table{ width:100%; border-collapse:collapse; }
  .od-table th, .od-table td{ padding:10px; border-bottom:1px solid var(--card); }
  .od-table th{ text-align:left; }
  .od-table td.num{ text-align:right; }
</style>

<h2>Pedido {{ orden.numero }}</h2>

<!-- Timeline de estado (sin CSS inline con lógica) -->
<article class="card" style="padding:18px">
  {% with s=orden.status %}
  <div class="timeline">
    {# PENDIENTE #}
    <span class="chip
      {% if s == 'PENDIENTE' %}is-active
      {% elif s in 'PAGADA,ENVIADA,ENTREGADA' %}is-done
      {% else %}is-idle{% endif %}">PENDIENTE</span>
    <span class="sep">›</span>
    {# PAGADA #}
    <span class="chip
      {% if s == 'PAGADA' %}is-active
      {% elif s in 'ENVIADA,ENTREGADA' %}is-done
      {% elif s == 'PENDIENTE' %}is-idle
      {% else %}is-idle{% endif %}">PAGADA</span>
    <span class="sep">›</span>
    {# ENVIADA #}
    <span class="chip
      {% if s == 'ENVIADA' %}is-active
      {% elif s == 'ENTREGADA' %}is-done
      {% else %}is-idle{% endif %}">ENVIADA</span>
    <span class="sep">›</span>
    {# ENTREGADA #}
    <span class="chip
      {% if s == 'ENTREGADA' %}is-active{% else %}is-idle{% endif %}">ENTREGADA</span>

    {% if s == "CANCELADA" %}
      <span class="sep">›</span>
      <span class="chip is-active" style="background:#ff4d6d;">CANCELADA</span>
    {% endif %}
  </div>
  {% endwith %}
</article>

<div class="grid" style="display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));align-items:start">

  <!-- Envío -->
  <article class="card">
    <h3 class="card-title">Datos de envío</h3>
    <div style="display:grid;gap:.3rem;margin-top:.5rem">
      <p><strong>Nombre:</strong> {{ orden.shipping_name|default:"—" }}</p>
      <p><strong>Teléfono:</strong> {{ orden.shipping_phone|default:"—" }}</p>
      <p><strong>Dirección:</strong> {{ orden.shipping_address|default:"—" }}</p>
      <p><strong>Creado:</strong> {{ orden.created_at|date:"Y-m-d H:i" }}</p>
      {% if orden.shipped_at %}
        <p><strong>Enviado:</strong> {{ orden.shipped_at|date:"Y-m-d H:i" }}</p>
      {% endif %}
      {% if orden.delivered_at %}
        <p><strong>Entregado:</strong> {{ orden.delivered_at|date:"Y-m-d H:i" }}</p>
      {% endif %}
    </div>

    {% if orden.tracking_code %}
      <div class="divider" style="height:1px;background:var(--card);margin:12px 0"></div>
      <p><strong>Tracking:</strong> {{ orden.shipping_carrier|default:"—" }} · <code>{{ orden.tracking_code }}</code></p>
    {% endif %}

    {% if user.is_staff %}
      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn btn-ghost" href="{% url 'orders:set_tracking' orden.numero %}">Editar tracking</a>
      </div>
    {% endif %}
  </article>

  <!-- Resumen / total -->
  <article class="card">
    <h3 class="card-title">Resumen</h3>
    <div style="display:flex;justify-content:space-between;margin-top:10px">
      <span>Total</span>
      <strong>$ {{ orden.total|floatformat:2 }}</strong>
    </div>

    {% if orden.usuario %}
      <div style="margin-top:12px;opacity:.8">
        <small>Cliente: {{ orden.usuario.email }}</small>
      </div>
    {% endif %}
  </article>

</div>

<!-- Ítems -->
<article class="card">
  <h3 class="card-title">Productos</h3>

  {% if orden.items.all %}
    <div style="overflow:auto;margin-top:10px">
      <table class="od-table">
        <thead>
          <tr>
            <th>Producto</th>
            <th style="text-align:center;">Cant.</th>
            <th class="num">Precio</th>
            <th class="num">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          {% for it in orden.items.all %}
            <tr>
              <td>
                {% if it.producto and it.producto.slug %}
                  <a href="{% url 'catalog:product_detail' it.producto.slug %}">{{ it.producto.nombre }}</a>
                {% else %}
                  {{ it.producto.nombre|default:"Producto" }}
                {% endif %}
              </td>
              <td style="text-align:center;">{{ it.cantidad }}</td>
              <td class="num">$ {{ it.precio_unitario|floatformat:2 }}</td>
              <td class="num">$ {{ it.subtotal|floatformat:2 }}</td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="3" class="num" style="text-align:right;">Total</th>
            <th class="num">$ {{ orden.total|floatformat:2 }}</th>
          </tr>
        </tfoot>
      </table>
    </div>
  {% else %}
    <p style="opacity:.8;margin-top:.5rem">No hay ítems en la orden.</p>
  {% endif %}
</article>

<!-- Acciones staff -->
{% if user.is_staff %}
  <article class="card" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
    <span style="opacity:.7">Acciones rápidas (staff)</span>
    {% if orden.status == "PAGADA" %}
      <a class="btn" href="{% url 'orders:set_tracking' orden.numero %}">Cargar tracking / Enviar</a>
    {% endif %}
  </article>
{% endif %}

<div style="margin-top:10px">
  <a class="btn btn-ghost" href="{% url 'catalog:product_list' %}">Seguir comprando</a>
</div>

{% endblock %}
